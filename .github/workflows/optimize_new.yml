name: Optimize Videos Workflow
on:
  push:
    paths:
      - 'preview/custom/*.mp4'
      - 'preview/custom/*.mov'
      # - 'preview/apple/*.mp4'
      # - 'preview/apple/*.mov'

  workflow_dispatch:

jobs:
  optimize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E 'preview/custom/.*\.(mp4|mov)$' || true)
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Install FFmpeg
        if: steps.changed-files.outputs.files != ''
        run: sudo apt-get install ffmpeg

      - name: Optimize Videos
        if: steps.changed-files.outputs.files != ''
        run: |
          for file in ${{ steps.changed-files.outputs.files }}; do
            if [ -f "$file" ]; then
              ext="${file##*.}"
              echo "Optimizing $file"
              ffmpeg -y -i "$file" -vcodec libx264 -crf 28 "${file%.*}_tmp.$ext"
              mv "${file%.*}_tmp.$ext" "$file"
            fi
          done

      - name: Commit and push changes
        if: steps.changed-files.outputs.files != ''
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          branch_name="optimization/video-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $branch_name
          git add .
          git commit -m "Optimize video files"
          git push origin $branch_name
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV